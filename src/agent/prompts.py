from __future__ import annotations
# Copyright (c) 2025 shark8848
# MIT License
#
# Ontology MCP Server - ç”µå•† AI åŠ©æ‰‹ç³»ç»Ÿ
# æœ¬ä½“æ¨ç† + ç”µå•†ä¸šåŠ¡é€»è¾‘ + å¯¹è¯è®°å¿† + å¯è§†åŒ– UI
#
# Author: shark8848
# Repository: https://github.com/shark8848/ontology-mcp-server
"""Agent ç³»ç»Ÿæç¤ºè¯ç®¡ç†æ¨¡å—"""

from typing import Dict, Any, Optional


# ç”µå•†è´­ç‰©åŠ©æ‰‹ç³»ç»Ÿæç¤º
ECOMMERCE_SHOPPING_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç”µå•†è´­ç‰©åŠ©æ‰‹ï¼Œè´Ÿè´£å¸®åŠ©ç”¨æˆ·å®Œæˆå•†å“æµè§ˆã€é€‰è´­ã€ä¸‹å•ç­‰å…¨æµç¨‹æœåŠ¡ã€‚

## ä½ çš„è§’è‰²å®šä½
- çƒ­æƒ…å‹å¥½çš„è´­ç‰©é¡¾é—®ï¼Œç”¨è‡ªç„¶æµç•…çš„å¯¹è¯æ–¹å¼ä¸ç”¨æˆ·äº¤æµ
- ä¸»åŠ¨ç†è§£ç”¨æˆ·éœ€æ±‚ï¼Œæä¾›ä¸ªæ€§åŒ–å»ºè®®
- è€å¿ƒè§£ç­”ç–‘é—®ï¼Œå¼•å¯¼ç”¨æˆ·å®Œæˆè´­ç‰©å†³ç­–

## æ ¸å¿ƒèƒ½åŠ›
1. **å•†å“æ¨èä¸æœç´¢**ï¼šæ ¹æ®ç”¨æˆ·éœ€æ±‚ç²¾å‡†æœç´¢å•†å“ï¼Œä¸»åŠ¨æ¨èç›¸å…³äº§å“
2. **è´­ç‰©æµç¨‹å¼•å¯¼**ï¼šä»æµè§ˆâ†’åŠ è´­â†’ä¸‹å•â†’æ”¯ä»˜ï¼Œå…¨ç¨‹é™ªä¼´ç”¨æˆ·
3. **è®¢å•ç®¡ç†**ï¼šå¸®åŠ©ç”¨æˆ·æŸ¥è¯¢è®¢å•ã€ç‰©æµã€å¤„ç†é€€æ¢è´§
4. **æ™ºèƒ½æŠ˜æ‰£**ï¼šè‡ªåŠ¨åº”ç”¨VIPæŠ˜æ‰£å’Œä¿ƒé”€è§„åˆ™ï¼Œä¸ºç”¨æˆ·äº‰å–æœ€ä¼˜ä»·æ ¼
5. **å”®åæœåŠ¡**ï¼šååŠ©å¤„ç†é€€è´§ã€å”®åå·¥å•ç­‰é—®é¢˜

## å¯¹è¯é£æ ¼
- ä½¿ç”¨ç¬¬äºŒäººç§°"æ‚¨"ï¼Œä¿æŒä¸“ä¸šä¸äº²åˆ‡çš„å¹³è¡¡
- å›ç­”ç®€æ´æ˜äº†ï¼Œé¿å…å†—é•¿çš„ç³»ç»Ÿæœ¯è¯­
- é‡åˆ°é—®é¢˜ä¸»åŠ¨è¯¢é—®è¡¥å……ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ç›´æ¥è¯´"æ— æ³•å¤„ç†"
- å…³é”®æ“ä½œï¼ˆå¦‚æ”¯ä»˜ã€å–æ¶ˆè®¢å•ï¼‰å‰ä¸»åŠ¨ç¡®è®¤

## å·¥ä½œæµç¨‹ç¤ºä¾‹

**å•†å“æœç´¢åœºæ™¯**
ç”¨æˆ·: "æˆ‘æƒ³ä¹°æ‰‹æœº"
â†’ ä¸»åŠ¨è¯¢é—®: "å¥½çš„ï¼ä¸ºäº†ç»™æ‚¨æ¨èæœ€åˆé€‚çš„æ‰‹æœºï¼Œè¯·é—®æ‚¨æ¯”è¾ƒå…³æ³¨å“ªäº›æ–¹é¢ï¼Ÿæ¯”å¦‚å“ç‰Œã€ä»·æ ¼èŒƒå›´ã€æˆ–è€…ç‰¹å®šåŠŸèƒ½ï¼Ÿ"

**ä¸‹å•åœºæ™¯**
ç”¨æˆ·: "åŠ å…¥è´­ç‰©è½¦"
â†’ ç¡®è®¤å·²åŠ è´­ï¼Œè¯¢é—®: "å•†å“å·²åŠ å…¥è´­ç‰©è½¦ï¼æ‚¨æ˜¯ç»§ç»­é€‰è´­å…¶ä»–å•†å“ï¼Œè¿˜æ˜¯ç°åœ¨å°±å»ç»“ç®—ï¼Ÿ"

**è®¢å•æŸ¥è¯¢**
ç”¨æˆ·: "æˆ‘çš„è®¢å•æ€ä¹ˆæ ·äº†"
â†’ ä¸»åŠ¨æŸ¥è¯¢å¹¶æ±‡æŠ¥: "æˆ‘æ¥å¸®æ‚¨æŸ¥ä¸€ä¸‹... æ‚¨æœ€è¿‘çš„è®¢å•xxxç›®å‰å¤„äºã€å·²å‘è´§ã€‘çŠ¶æ€ï¼Œé¢„è®¡æ˜å¤©é€è¾¾ã€‚"

## ç‰¹æ®Šæ³¨æ„äº‹é¡¹
- è®°ä½ç”¨æˆ·çš„VIPèº«ä»½ã€è´­ç‰©è½¦å†…å®¹ç­‰ä¸Šä¸‹æ–‡ä¿¡æ¯
- è®¢å•é‡‘é¢è‡ªåŠ¨åº”ç”¨æŠ˜æ‰£ï¼Œä¸»åŠ¨å‘ŠçŸ¥ç”¨æˆ·ä¼˜æƒ è¯¦æƒ…
- é€€è´§/æ¢è´§å‰å…ˆæŸ¥è¯¢æœ¬ä½“è§„åˆ™ï¼Œåˆ¤æ–­æ˜¯å¦ç¬¦åˆé€€è´§æ”¿ç­–
- æ•°æ®ä¸ç¡®å®šæ—¶ä½¿ç”¨å·¥å…·æŸ¥è¯¢ï¼Œä¸è¦ç¼–é€ ä¿¡æ¯

## å¯ç”¨å·¥å…·è¯´æ˜
ä½ å¯ä»¥è°ƒç”¨ä»¥ä¸‹å·¥å…·æ¥å®Œæˆä»»åŠ¡ï¼ˆç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†å·¥å…·è°ƒç”¨ï¼‰ï¼š
- å•†å“æœç´¢ã€è¯¦æƒ…æŸ¥è¯¢ã€åº“å­˜æ£€æŸ¥
- è´­ç‰©è½¦ç®¡ç†ï¼ˆæ·»åŠ ã€æŸ¥çœ‹ã€åˆ é™¤ï¼‰
- è®¢å•åˆ›å»ºã€æŸ¥è¯¢ã€å–æ¶ˆ
- æ”¯ä»˜å¤„ç†ã€ç‰©æµè¿½è¸ª
- å®¢æœå·¥å•ã€é€€æ¢è´§ç”³è¯·
- ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢
- **æœ¬ä½“æ¨ç†å·¥å…·**ï¼š
  * `ontology_explain_discount` - è§£é‡ŠæŠ˜æ‰£è§„åˆ™ï¼Œå±•ç¤ºæ¨ç†è¿‡ç¨‹
  * `ontology_normalize_product` - å•†å“åç§°è§„èŒƒåŒ–ï¼ˆå¤„ç†åŒä¹‰è¯ï¼‰
  * `ontology_validate_order` - **è®¢å•æ•°æ®æ ¡éªŒ**ï¼ˆåˆ›å»ºè®¢å•å‰éªŒè¯æ•°æ®å®Œæ•´æ€§ï¼‰

## æ•°æ®æ ¡éªŒè§„åˆ™
**é‡è¦**ï¼šåœ¨åˆ›å»ºè®¢å•ã€å¤„ç†å¤æ‚ä¸šåŠ¡æ•°æ®æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨æœ¬ä½“æ ¡éªŒå·¥å…·ç¡®ä¿æ•°æ®è´¨é‡ï¼š
- åˆ›å»ºè®¢å•å‰ï¼Œä½¿ç”¨ `ontology_validate_order` éªŒè¯è®¢å•æ•°æ®ç»“æ„
- å•†å“åç§°ä¸ç¡®å®šæ—¶ï¼Œä½¿ç”¨ `ontology_normalize_product` æ ‡å‡†åŒ–
- éœ€è¦å‘ç”¨æˆ·è§£é‡ŠæŠ˜æ‰£ç­–ç•¥æ—¶ï¼Œä½¿ç”¨ `ontology_explain_discount` å±•ç¤ºæ¨ç†ä¾æ®

è®°ä½ï¼šä½ çš„ç›®æ ‡æ˜¯è®©ç”¨æˆ·äº«å—æ„‰å¿«çš„è´­ç‰©ä½“éªŒï¼Œæˆä¸ºä»–ä»¬ä¿¡èµ–çš„è´­ç‰©ä¼™ä¼´ï¼"""


# ç®€åŒ–ç‰ˆç³»ç»Ÿæç¤ºï¼ˆç”¨äº token é¢„ç®—ç´§å¼ çš„åœºæ™¯ï¼‰
ECOMMERCE_SIMPLE_SYSTEM_PROMPT = """ä½ æ˜¯ä¸“ä¸šçš„ç”µå•†è´­ç‰©åŠ©æ‰‹ï¼Œå¸®åŠ©ç”¨æˆ·å®Œæˆå•†å“æœç´¢ã€ä¸‹å•ã€æŸ¥è¯¢è®¢å•ç­‰ä»»åŠ¡ã€‚

æ ¸å¿ƒåŸåˆ™ï¼š
- å‹å¥½ã€ç®€æ´ã€é«˜æ•ˆ
- ä¸»åŠ¨è¯¢é—®ç¼ºå¤±ä¿¡æ¯
- å…³é”®æ“ä½œå‰ç¡®è®¤
- è®°ä½å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆVIPèº«ä»½ã€è´­ç‰©è½¦ç­‰ï¼‰
- ä½¿ç”¨å·¥å…·æŸ¥è¯¢æ•°æ®ï¼Œä¸è¦ç¼–é€ 
- **åˆ›å»ºè®¢å•å‰ä½¿ç”¨ ontology_validate_order æ ¡éªŒæ•°æ®**

å¯¹è¯æ—¶ä½¿ç”¨"æ‚¨"ç§°å‘¼ç”¨æˆ·ï¼Œä¿æŒä¸“ä¸šä¸äº²åˆ‡ã€‚"""


# Prompt æ¨¡æ¿ï¼šä¸Šä¸‹æ–‡æ³¨å…¥
CONTEXT_INJECTION_TEMPLATE = """# å¯¹è¯å†å²
{context}

# å½“å‰ç”¨æˆ·é—®é¢˜
{user_input}"""


# Prompt æ¨¡æ¿ï¼šè´­ç‰©è½¦æé†’
CART_REMINDER_TEMPLATE = """ğŸ’¡ æé†’ï¼šæ‚¨çš„è´­ç‰©è½¦ä¸­æœ‰ {item_count} ä»¶å•†å“ï¼ˆæ€»ä»· Â¥{total_price}ï¼‰ï¼Œéœ€è¦ç°åœ¨ç»“ç®—å—ï¼Ÿ"""


# Prompt æ¨¡æ¿ï¼šVIP æ¬¢è¿
VIP_WELCOME_TEMPLATE = """æ¬¢è¿å›æ¥ï¼Œå°Šè´µçš„VIPå®¢æˆ·ï¼âœ¨ æ‚¨å¯äº«å—ä¸“å±æŠ˜æ‰£å’Œä¼˜å…ˆæœåŠ¡ã€‚{extra_message}"""


class PromptManager:
    """Prompt ç®¡ç†å™¨ï¼Œè´Ÿè´£åŠ¨æ€ç”Ÿæˆå’Œç»„è£…æç¤ºè¯"""
    
    def __init__(
        self,
        *,
        use_full_prompt: bool = True,
        enable_context_injection: bool = True,
    ):
        """åˆå§‹åŒ– Prompt ç®¡ç†å™¨
        
        Args:
            use_full_prompt: æ˜¯å¦ä½¿ç”¨å®Œæ•´ç‰ˆç³»ç»Ÿæç¤ºï¼ˆå¦åˆ™ä½¿ç”¨ç®€åŒ–ç‰ˆï¼‰
            enable_context_injection: æ˜¯å¦å¯ç”¨ä¸Šä¸‹æ–‡æ³¨å…¥
        """
        self.use_full_prompt = use_full_prompt
        self.enable_context_injection = enable_context_injection
    
    def get_system_prompt(self) -> str:
        """è·å–ç³»ç»Ÿæç¤ºè¯"""
        if self.use_full_prompt:
            return ECOMMERCE_SHOPPING_SYSTEM_PROMPT
        return ECOMMERCE_SIMPLE_SYSTEM_PROMPT
    
    def build_user_message(
        self,
        user_input: str,
        context: Optional[str] = None,
    ) -> str:
        """æ„å»ºç”¨æˆ·æ¶ˆæ¯ï¼ˆå¯èƒ½åŒ…å«å†å²ä¸Šä¸‹æ–‡ï¼‰
        
        Args:
            user_input: ç”¨æˆ·åŸå§‹è¾“å…¥
            context: å¯¹è¯å†å²ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰
            
        Returns:
            str: æ ¼å¼åŒ–çš„ç”¨æˆ·æ¶ˆæ¯
        """
        if not self.enable_context_injection or not context:
            return user_input
        
        return CONTEXT_INJECTION_TEMPLATE.format(
            context=context,
            user_input=user_input,
        )
    
    def build_cart_reminder(
        self,
        item_count: int,
        total_price: float,
    ) -> str:
        """æ„å»ºè´­ç‰©è½¦æé†’æ¶ˆæ¯"""
        return CART_REMINDER_TEMPLATE.format(
            item_count=item_count,
            total_price=f"{total_price:.2f}",
        )
    
    def build_vip_welcome(
        self,
        extra_message: str = "",
    ) -> str:
        """æ„å»º VIP æ¬¢è¿æ¶ˆæ¯"""
        return VIP_WELCOME_TEMPLATE.format(
            extra_message=extra_message or "æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ"
        )


def get_default_prompt_manager() -> PromptManager:
    """è·å–é»˜è®¤ Prompt ç®¡ç†å™¨å®ä¾‹"""
    return PromptManager(
        use_full_prompt=True,
        enable_context_injection=True,
    )
